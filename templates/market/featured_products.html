{% extends 'base.html' %}
{% load i18n static %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold text-dark mb-3">
                <i class="fas fa-star text-warning me-3"></i>
                {% trans "Featured Products" %}
            </h1>
            <p class="lead text-muted mb-4">
                {% trans "Discover our handpicked selection of exceptional products from trusted sellers" %}
            </p>
            
            <!-- Stats -->
            <div class="row justify-content-center">
                <div class="col-auto">
                    <div class="card border-0 bg-light">
                        <div class="card-body py-3">
                            <div class="row g-4 text-center">
                                <div class="col-md-4">
                                    <h3 class="text-gold fw-bold mb-1">{{ featured_products.count }}</h3>
                                    <small class="text-muted">{% trans "Featured Products" %}</small>
                                </div>
                                <div class="col-md-4">
                                    <h3 class="text-gold fw-bold mb-1">
                                        {% with featured_products|dictsort:"shop.name"|length as shops %}
                                        {{ shops }}
                                        {% endwith %}
                                    </h3>
                                    <small class="text-muted">{% trans "Quality Sellers" %}</small>
                                </div>
                                <div class="col-md-4">
                                    <h3 class="text-gold fw-bold mb-1">100%</h3>
                                    <small class="text-muted">{% trans "Quality Verified" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="alert alert-warning border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-certificate fa-2x me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-2">{% trans "What are Featured Products?" %}</h5>
                        <p class="mb-0">
                            {% trans "Featured products are carefully selected by our team for their exceptional quality, popularity, and seller reputation. These products represent the best of what SokoLetu has to offer." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Sort Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="fas fa-filter me-2 text-gold"></i>
                                {{ featured_products.paginator.count }} {% trans "featured products found" %}
                            </h6>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary btn-sm active" data-sort="newest">
                                    <i class="fas fa-sort-amount-down me-1"></i>{% trans "Newest" %}
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-sort="price-low">
                                    <i class="fas fa-sort-amount-up me-1"></i>{% trans "Price: Low to High" %}
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-sort="price-high">
                                    <i class="fas fa-sort-amount-down me-1"></i>{% trans "Price: High to Low" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Products Grid -->
    <div class="row">
        <div class="col-12">
            {% if featured_products %}
            <div class="row g-4" id="productsGrid">
                {% for product in featured_products %}
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card product-card h-100 border-0 shadow-sm position-relative">
                        <!-- Featured Badge -->
                        <div class="position-absolute top-0 start-0 m-3">
                            <span class="badge bg-warning text-dark fs-6 py-2">
                                <i class="fas fa-crown me-1"></i>{% trans "FEATURED" %}
                            </span>
                        </div>

                        <!-- Product Image -->
                        <div class="position-relative">
                            {% with product.images.first as image %}
                            <img src="{% if image %}{{ image.image }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}" 
                                 class="card-img-top" 
                                 alt="{{ product.name }}"
                                 style="height: 220px; object-fit: cover;">
                            {% endwith %}
                            
                            <!-- Additional Badges -->
                            <div class="position-absolute bottom-0 start-0 m-2">
                                {% if product.discount_percentage %}
                                <span class="badge bg-danger fs-6">
                                    -{{ product.discount_percentage }}%
                                </span>
                                {% endif %}
                            </div>

                            <!-- View Count -->
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <small class="badge bg-dark bg-opacity-75 text-white">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </small>
                            </div>

                            <!-- Quick Actions Overlay -->
                            <div class="position-absolute top-0 end-0 m-2">
                                <div class="btn-group-vertical">
                                    <button class="btn btn-light btn-sm rounded-circle mb-1 wishlist-btn" 
                                            data-product-id="{{ product.id }}"
                                            title="{% trans 'Add to Wishlist' %}">
                                        <i class="far fa-heart"></i>
                                    </button>
                                    <button class="btn btn-light btn-sm rounded-circle compare-btn" 
                                            data-product-id="{{ product.id }}"
                                            title="{% trans 'Compare Product' %}">
                                        <i class="fas fa-balance-scale"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body">
                            <!-- Category -->
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-tag me-1"></i>
                                <a href="{{ product.category.get_absolute_url }}" class="text-muted text-decoration-none">
                                    {{ product.category.name }}
                                </a>
                            </small>
                            
                            <!-- Product Name - FIXED: Removed stretched-link -->
                            <h6 class="card-title fw-bold mb-2">
                                <a href="{{ product.get_absolute_url }}" class="text-dark text-decoration-none">
                                    {{ product.name }}
                                </a>
                            </h6>
                            
                            <!-- Shop with Verification -->
                            <div class="d-flex align-items-center mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-store me-1"></i>
                                    <a href="{{ product.shop.get_absolute_url }}" class="text-muted text-decoration-none">
                                        {{ product.shop.name }}
                                    </a>
                                </small>
                                {% if product.shop.is_verified %}
                                <i class="fas fa-check-circle text-success ms-1 small" title="{% trans 'Verified Seller' %}"></i>
                                {% endif %}
                            </div>

                            <!-- Rating and Reviews -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="text-warning small">
                                    {% with product.get_average_rating as avg_rating %}
                                    {% if avg_rating %}
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= avg_rating %}
                                            <i class="fas fa-star"></i>
                                            {% elif forloop.counter|add:"-0.5" <= avg_rating %}
                                            <i class="fas fa-star-half-alt"></i>
                                            {% else %}
                                            <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <small class="text-muted ms-1">({{ product.review_count }} {% trans "reviews" %})</small>
                            </div>
                            
                            <!-- Price -->
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <span class="h4 text-gold fw-bold mb-0">
                                        TSh {{ product.price|floatformat:0 }}
                                    </span>
                                    {% if product.compare_price %}
                                    <small class="text-muted text-decoration-line-through ms-2 fs-6">
                                        TSh {{ product.compare_price|floatformat:0 }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Stock Status -->
                            <div class="mb-3">
                                {% if product.is_in_stock %}
                                    {% if product.is_low_stock %}
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {% trans "Low Stock" %} ‚Ä¢ {{ product.stock_quantity }} {% trans "left" %}
                                    </small>
                                    {% else %}
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        {% trans "In Stock" %} ‚Ä¢ {{ product.stock_quantity }} {% trans "available" %}
                                    </small>
                                    {% endif %}
                                {% else %}
                                    <small class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>
                                        {% trans "Out of Stock" %}
                                    </small>
                                {% endif %}
                            </div>

                            <!-- Product Condition -->
                            <div class="mb-3">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-certificate me-1 text-gold"></i>
                                    {{ product.get_condition_display }}
                                </span>
                                {% if product.brand %}
                                <span class="badge bg-light text-dark ms-1">
                                    <i class="fas fa-tag me-1 text-gold"></i>
                                    {{ product.brand }}
                                </span>
                                {% endif %}
                            </div>

                            <!-- Quick Stats -->
                            <div class="d-flex justify-content-between small text-muted">
                                <span>
                                    <i class="fas fa-eye me-1"></i>
                                    {{ product.view_count }} {% trans "views" %}
                                </span>
                                <span>
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    {{ product.total_sold }} {% trans "sold" %}
                                </span>
                                <span>
                                    <i class="fas fa-heart me-1"></i>
                                    {{ product.wishlist_count }} {% trans "wishlists" %}
                                </span>
                            </div>
                        </div>

                        <!-- Card Footer -->
                        <div class="card-footer bg-transparent border-top-0 pt-0">
                            <div class="d-grid gap-2">
                                {% if user.is_authenticated %}
                                <button class="btn btn-gold btn-lg add-to-cart-btn" 
                                        data-product-id="{{ product.id }}"
                                        {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    {% if product.is_in_stock %}
                                        {% trans "Add to Cart" %}
                                    {% else %}
                                        {% trans "Notify When Available" %}
                                    {% endif %}
                                </button>
                                {% else %}
                                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-gold btn-lg">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    {% trans "Login to Purchase" %}
                                </a>
                                {% endif %}
                                
                                <div class="d-flex gap-2">
                                    <a href="{{ product.get_absolute_url }}" class="btn btn-outline-gold btn-sm flex-fill">
                                        <i class="fas fa-search me-1"></i>{% trans "View Details" %}
                                    </a>
                                    <button class="btn btn-outline-gold btn-sm flex-fill share-btn" 
                                            data-product-url="{{ product.get_absolute_url }}"
                                            title="{% trans 'Share Product' %}">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if featured_products.has_other_pages %}
            <nav aria-label="Featured products pagination" class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if featured_products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ featured_products.previous_page_number }}">
                            <i class="fas fa-chevron-left me-1"></i>{% trans "Previous" %}
                        </a>
                    </li>
                    {% endif %}

                    {% for num in featured_products.paginator.page_range %}
                        {% if featured_products.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > featured_products.number|add:'-3' and num < featured_products.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if featured_products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ featured_products.next_page_number }}">
                            {% trans "Next" %} <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <i class="fas fa-star fa-4x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">{% trans "No Featured Products Available" %}</h3>
                        <p class="text-muted mb-4">
                            {% trans "We're currently updating our featured products selection. Check back soon for exceptional products handpicked just for you." %}
                        </p>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <a href="{% url 'market:product_list' %}" class="btn btn-gold btn-lg">
                                <i class="fas fa-shopping-bag me-2"></i>{% trans "Browse All Products" %}
                            </a>
                            <a href="{% url 'market:category_list' %}" class="btn btn-outline-gold btn-lg">
                                <i class="fas fa-th-large me-2"></i>{% trans "Browse Categories" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quality Assurance Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body p-5 text-center">
                    <h3 class="fw-bold text-dark mb-4">{% trans "Why Shop Featured Products?" %}</h3>
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-award fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Quality Assured" %}</h5>
                            <p class="text-muted small">
                                {% trans "Every featured product meets our high quality standards" %}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-shield-alt fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Trusted Sellers" %}</h5>
                            <p class="text-muted small">
                                {% trans "From verified sellers with excellent track records" %}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-shipping-fast fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Fast Shipping" %}</h5>
                            <p class="text-muted small">
                                {% trans "Priority shipping and reliable delivery" %}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-headset fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Premium Support" %}</h5>
                            <p class="text-muted small">
                                {% trans "Dedicated customer support for featured products" %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .product-card {
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
    }
    
    .btn-outline-gold {
        border-color: var(--gold);
        color: var(--gold);
    }
    
    .btn-outline-gold:hover {
        background-color: var(--gold);
        color: white;
    }
    
    .feature-icon {
        transition: transform 0.3s ease;
    }
    
    .card:hover .feature-icon {
        transform: scale(1.1);
    }
    
    .badge.fs-6 {
        font-size: 0.75em !important;
        padding: 0.5em 0.75em;
    }
    
    .add-to-cart-btn:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.6;
    }
    
    .btn-loading {
        position: relative;
        color: transparent !important;
    }
    
    .btn-loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .cart-badge.updated {
        animation: pulse 0.6s ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    .custom-toast {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Featured products page loaded');
    
    // Debug: Check all add to cart buttons
    const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
    console.log(`üîç Found ${addToCartButtons.length} add to cart buttons`);
    
    addToCartButtons.forEach(button => {
        console.log('üì¶ Button product ID:', button.dataset.productId, 'Disabled:', button.disabled);
    });

    // Add to Cart functionality - FIXED VERSION
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.dataset.productId;
            console.log('üõí Add to cart clicked for product:', productId);
            
            // Check if user is authenticated
            {% if not user.is_authenticated %}
            console.log('üîê User not authenticated, redirecting to login');
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
            return;
            {% endif %}
            
            // Check if button is disabled (out of stock)
            if (this.disabled) {
                console.log('‚õî Button disabled - product out of stock');
                showToast('{% trans "This product is currently out of stock" %}', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = this.innerHTML;
            const originalClass = this.className;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Adding..." %}';
            this.disabled = true;
            this.classList.add('btn-loading');
            
            try {
                console.log('üì° Making AJAX request to add to cart...');
                
                // Get CSRF token
                function getCSRFToken() {
                    // Try to get from form input first
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) {
                        return csrfToken.value;
                    }
                    
                    // Fallback: check cookies
                    const name = 'csrftoken';
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                const csrfToken = getCSRFToken();
                console.log('üîë CSRF Token found:', !!csrfToken);
                
                // Build the URL - using absolute path to avoid issues
                const addToCartUrl = `/en/orders/cart/add/${productId}/`;
                console.log('üåê URL:', addToCartUrl);
                
                // Make AJAX request
                const response = await fetch(addToCartUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                console.log('üì® Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Response data:', data);
                
                if (data.success) {
                    // Show success state
                    this.innerHTML = '<i class="fas fa-check me-2"></i>{% trans "Added!" %}';
                    this.classList.remove('btn-gold', 'btn-loading');
                    this.classList.add('btn-success');
                    
                    // Update cart count
                    await updateCartCount();
                    
                    // Show success message
                    showToast(data.message || '{% trans "Product added to cart successfully!" %}', 'success');
                    
                } else {
                    // Show error state
                    this.innerHTML = '<i class="fas fa-times me-2"></i>{% trans "Failed" %}';
                    this.classList.remove('btn-gold', 'btn-loading');
                    this.classList.add('btn-danger');
                    
                    // Show error message
                    showToast(data.message || '{% trans "Failed to add product to cart" %}', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding to cart:', error);
                this.innerHTML = '<i class="fas fa-times me-2"></i>{% trans "Error" %}';
                this.classList.remove('btn-gold', 'btn-loading');
                this.classList.add('btn-danger');
                
                showToast('{% trans "Network error. Please check your connection and try again." %}', 'error');
            } finally {
                // Reset button after 2 seconds
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                    this.className = originalClass;
                }, 2000);
            }
        });
    });

    // Update cart count function
    async function updateCartCount() {
        try {
            console.log('üîÑ Updating cart count...');
            const response = await fetch('{% url "orders:get_cart_count" %}', {
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch cart count');
            }
            
            const data = await response.json();
            console.log('üì¶ Cart count data:', data);
            
            const cartBadges = document.querySelectorAll('.cart-badge, .cart-badge-sidebar, .cart-badge-dropdown');
            console.log(`üéØ Updating ${cartBadges.length} cart badges`);
            
            cartBadges.forEach(badge => {
                const oldCount = parseInt(badge.textContent) || 0;
                const newCount = data.count || 0;
                
                console.log(`üîÑ Badge update: ${oldCount} -> ${newCount}`);
                
                badge.textContent = newCount;
                badge.classList.add('updated');
                setTimeout(() => badge.classList.remove('updated'), 600);
            });
            
        } catch (error) {
            console.error('‚ùå Error updating cart count:', error);
        }
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.custom-toast').forEach(toast => {
            toast.remove();
        });
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 100px; right: 20px; z-index: 1060; min-width: 300px;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : 
                  type === 'error' ? '<i class="fas fa-exclamation-triangle me-2"></i>' : 
                  type === 'warning' ? '<i class="fas fa-exclamation-circle me-2"></i>' :
                  '<i class="fas fa-info-circle me-2"></i>'}
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }

    // Other functionality
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.dataset.productId;
            const icon = this.querySelector('i');
            
            {% if not user.is_authenticated %}
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
            return;
            {% endif %}
            
            if (icon.classList.contains('far')) {
                icon.classList.replace('far', 'fas');
                icon.style.color = '#dc3545';
                this.style.backgroundColor = '#dc3545';
                this.style.color = 'white';
                showToast('{% trans "Added to wishlist!" %}', 'success');
            } else {
                icon.classList.replace('fas', 'far');
                icon.style.color = '';
                this.style.backgroundColor = '';
                this.style.color = '';
                showToast('{% trans "Removed from wishlist" %}', 'info');
            }
        });
    });

    // Share functionality
    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productUrl = this.dataset.productUrl;
            const fullUrl = window.location.origin + productUrl;
            
            if (navigator.share) {
                navigator.share({
                    title: '{% trans "Featured Product on SokoLetu" %}',
                    text: '{% trans "Check out this featured product!" %}',
                    url: fullUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(fullUrl).then(() => {
                    showToast('{% trans "Product link copied to clipboard!" %}', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('{% trans "Failed to copy link" %}', 'error');
                });
            }
        });
    });

    // Initialize cart count on page load
    updateCartCount();
    
    // Update cart count every 30 seconds to stay in sync
    setInterval(updateCartCount, 30000);
});
</script>
{% endblock %}