{% extends 'base.html' %}
{% load i18n static %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold text-dark mb-3">
                <i class="fas fa-bullhorn text-warning me-3"></i>
                {% trans "Sponsored Products" %}
            </h1>
            <p class="lead text-muted mb-4">
                {% trans "Discover featured promotions and sponsored listings from our trusted sellers" %}
            </p>
            
            <!-- Stats -->
            <div class="row justify-content-center">
                <div class="col-auto">
                    <div class="card border-0 bg-light">
                        <div class="card-body py-3">
                            <div class="row g-4 text-center">
                                <div class="col-md-3">
                                    <h3 class="text-gold fw-bold mb-1">{{ sponsored_products.count }}</h3>
                                    <small class="text-muted">{% trans "Active Campaigns" %}</small>
                                </div>
                                <div class="col-md-3">
                                    <h3 class="text-gold fw-bold mb-1">
                                        {% with sponsored_products|length as count %}
                                        {{ count }}
                                        {% endwith %}
                                    </h3>
                                    <small class="text-muted">{% trans "Sponsored Products" %}</small>
                                </div>
                                <div class="col-md-3">
                                    <h3 class="text-gold fw-bold mb-1">
                                        {% with sponsored_products|dictsort:"shop.name"|length as shops %}
                                        {{ shops }}
                                        {% endwith %}
                                    </h3>
                                    <small class="text-muted">{% trans "Participating Shops" %}</small>
                                </div>
                                <div class="col-md-3">
                                    <h3 class="text-gold fw-bold mb-1">24/7</h3>
                                    <small class="text-muted">{% trans "Promotion Visibility" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="alert alert-info border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-2">{% trans "What are Sponsored Products?" %}</h5>
                        <p class="mb-0">
                            {% trans "Sponsored products are premium listings promoted by our sellers to reach more customers. These campaigns help you discover amazing products while supporting local businesses." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sponsored Products Grid -->
    <div class="row">
        <div class="col-12">
            {% if sponsored_products %}
            <div class="row g-4">
                {% for product in sponsored_products %}
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card product-card h-100 border-warning shadow-lg">
                        <!-- Sponsored Ribbon -->
                        <div class="position-absolute top-0 start-0 end-0 text-center">
                            <div class="bg-warning text-dark py-1 px-3 d-inline-block">
                                <small class="fw-bold">
                                    <i class="fas fa-crown me-1"></i>{% trans "SPONSORED" %}
                                </small>
                            </div>
                        </div>

                        <!-- Product Image -->
                        <div class="position-relative pt-4">
                            {% with product.images.first as image %}
                            <img src="{% if image %}{{ image.image }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}" 
                                 class="card-img-top" 
                                 alt="{{ product.name }}"
                                 style="height: 200px; object-fit: cover;">
                            {% endwith %}
                            
                            <!-- Additional Badges -->
                            <div class="position-absolute top-0 start-0 m-2 mt-5">
                                {% if product.is_featured %}
                                <span class="badge bg-info">
                                    <i class="fas fa-star me-1"></i>{% trans "Featured" %}
                                </span>
                                {% endif %}
                                {% if product.discount_percentage %}
                                <span class="badge bg-danger">
                                    -{{ product.discount_percentage }}%
                                </span>
                                {% endif %}
                            </div>

                            <!-- View Count -->
                            <div class="position-absolute bottom-0 start-0 m-2">
                                <small class="badge bg-dark bg-opacity-75 text-white">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </small>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body">
                            <!-- Category -->
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-tag me-1"></i>
                                <a href="{{ product.category.get_absolute_url }}" class="text-muted text-decoration-none">
                                    {{ product.category.name }}
                                </a>
                            </small>
                            
                            <!-- Product Name -->
                            <h6 class="card-title fw-bold mb-2">
                                <a href="{{ product.get_absolute_url }}" class="text-dark text-decoration-none">
                                    {{ product.name|truncatewords:6 }}
                                </a>
                            </h6>
                            
                            <!-- Shop with Verification -->
                            <div class="d-flex align-items-center mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-store me-1"></i>
                                    <a href="{{ product.shop.get_absolute_url }}" class="text-muted text-decoration-none">
                                        {{ product.shop.name }}
                                    </a>
                                </small>
                                {% if product.shop.is_verified %}
                                <i class="fas fa-check-circle text-success ms-1 small" title="{% trans 'Verified Seller' %}"></i>
                                {% endif %}
                            </div>

                            <!-- Rating -->
                            <div class="d-flex align-items-center mb-2">
                                <div class="text-warning small">
                                    {% with product.get_average_rating as avg_rating %}
                                    {% if avg_rating %}
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= avg_rating %}
                                            <i class="fas fa-star"></i>
                                            {% elif forloop.counter|add:"-0.5" <= avg_rating %}
                                            <i class="fas fa-star-half-alt"></i>
                                            {% else %}
                                            <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <small class="text-muted ms-1">({{ product.review_count }})</small>
                            </div>
                            
                            <!-- Price -->
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <span class="h5 text-gold fw-bold mb-0">
                                        TSh {{ product.price|floatformat:0 }}
                                    </span>
                                    {% if product.compare_price %}
                                    <small class="text-muted text-decoration-line-through ms-1">
                                        TSh {{ product.compare_price|floatformat:0 }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Stock Status -->
                            <div class="mb-3">
                                {% if product.is_in_stock %}
                                    {% if product.is_low_stock %}
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {% trans "Low Stock" %} ({{ product.stock_quantity }} {% trans "left" %})
                                    </small>
                                    {% else %}
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        {% trans "In Stock" %}
                                    </small>
                                    {% endif %}
                                {% else %}
                                    <small class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>
                                        {% trans "Out of Stock" %}
                                    </small>
                                {% endif %}
                            </div>

                            <!-- Promotion Badge -->
                            <div class="mb-3">
                                <span class="badge bg-gradient-warning text-dark">
                                    <i class="fas fa-rocket me-1"></i>
                                    {% trans "Promoted Listing" %}
                                </span>
                            </div>
                        </div>

                        <!-- Card Footer -->
                        <div class="card-footer bg-transparent border-top-0 pt-0">
                            <div class="d-grid gap-2">
                                {% if user.is_authenticated %}
                                <button class="btn btn-warning btn-sm add-to-cart-btn" 
                                        data-product-id="{{ product.id }}"
                                        {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    {% if product.is_in_stock %}
                                        {% trans "Add to Cart" %}
                                    {% else %}
                                        {% trans "Out of Stock" %}
                                    {% endif %}
                                </button>
                                {% else %}
                                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    {% trans "Login to Buy" %}
                                </a>
                                {% endif %}
                                
                                <div class="d-flex gap-1">
                                    <button class="btn btn-outline-dark btn-sm flex-fill wishlist-btn" 
                                            data-product-id="{{ product.id }}"
                                            title="{% trans 'Add to Wishlist' %}">
                                        <i class="far fa-heart"></i>
                                    </button>
                                    <button class="btn btn-outline-dark btn-sm flex-fill share-btn" 
                                            data-product-url="{{ product.get_absolute_url }}"
                                            title="{% trans 'Share Product' %}">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Empty State -->
            {% else %}
            <div class="text-center py-5">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <i class="fas fa-bullhorn fa-4x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">{% trans "No Sponsored Products Available" %}</h3>
                        <p class="text-muted mb-4">
                            {% trans "There are currently no active sponsored campaigns. Check back later for featured promotions from our sellers." %}
                        </p>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <a href="{% url 'market:product_list' %}" class="btn btn-gold">
                                <i class="fas fa-shopping-bag me-2"></i>{% trans "Browse All Products" %}
                            </a>
                            <a href="{% url 'market:featured_products' %}" class="btn btn-outline-gold">
                                <i class="fas fa-star me-2"></i>{% trans "View Featured Products" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Become a Sponsor Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0">
                <div class="card-body p-5">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h3 class="fw-bold mb-3">{% trans "Want to Promote Your Products?" %}</h3>
                            <p class="mb-4">
                                {% trans "Reach thousands of potential customers by sponsoring your products. Boost your visibility and increase sales with our targeted promotion campaigns." %}
                            </p>
                            <div class="d-flex flex-wrap gap-2">
                                {% if user.is_authenticated and user.is_seller %}
                                <a href="#" class="btn btn-light btn-lg">
                                    <i class="fas fa-rocket me-2"></i>{% trans "Start Campaign" %}
                                </a>
                                {% else %}
                                <a href="{% url 'accounts:become_seller' %}" class="btn btn-light btn-lg">
                                    <i class="fas fa-store me-2"></i>{% trans "Become a Seller" %}
                                </a>
                                {% endif %}
                                <a href="#" class="btn btn-outline-light btn-lg">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "Learn More" %}
                                </a>
                            </div>
                        </div>
                        <div class="col-lg-4 text-center">
                            <i class="fas fa-chart-line fa-5x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Benefits Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center fw-bold text-dark mb-4">{% trans "Why Sponsor Your Products?" %}</h3>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-0 text-center h-100">
                        <div class="card-body">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-eye fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Increased Visibility" %}</h5>
                            <p class="text-muted">
                                {% trans "Get your products featured prominently across the platform to reach more potential customers." %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 text-center h-100">
                        <div class="card-body">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-bullseye fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Targeted Audience" %}</h5>
                            <p class="text-muted">
                                {% trans "Reach customers who are actively searching for products in your category." %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 text-center h-100">
                        <div class="card-body">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-chart-line fa-2x text-gold"></i>
                            </div>
                            <h5 class="fw-bold">{% trans "Boost Sales" %}</h5>
                            <p class="text-muted">
                                {% trans "Increase conversion rates and drive more sales with premium product placement." %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, var(--deep-green) 0%, #2E7D32 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    }
    
    .border-warning {
        border: 2px solid #FFC107 !important;
    }
    
    .shadow-lg {
        box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    }
    
    .product-card {
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px rgba(0,0,0,0.15) !important;
    }
    
    .feature-icon {
        transition: transform 0.3s ease;
    }
    
    .card:hover .feature-icon {
        transform: scale(1.1);
    }
    
    .btn-outline-gold {
        border-color: var(--gold);
        color: var(--gold);
    }
    
    .btn-outline-gold:hover {
        background-color: var(--gold);
        color: white;
    }
    
    .btn-loading {
        position: relative;
        color: transparent !important;
    }
    
    .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .custom-toast {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì¢ Sponsored products page loaded');
    
    // Add to Cart functionality for sponsored products
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.dataset.productId;
            console.log('üõí Add to cart clicked for sponsored product:', productId);
            
            // Check if user is authenticated
            {% if not user.is_authenticated %}
            console.log('üîê User not authenticated, redirecting to login');
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
            return;
            {% endif %}
            
            // Check if button is disabled (out of stock)
            if (this.disabled) {
                console.log('‚õî Button disabled - product out of stock');
                showToast('{% trans "This product is currently out of stock" %}', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = this.innerHTML;
            const originalClass = this.className;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Adding..." %}';
            this.disabled = true;
            this.classList.add('btn-loading');
            
            try {
                console.log('üì° Making AJAX request to add to cart...');
                
                // Get CSRF token
                function getCSRFToken() {
                    // Try to get from form input first
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) {
                        return csrfToken.value;
                    }
                    
                    // Fallback: check cookies
                    const name = 'csrftoken';
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                const csrfToken = getCSRFToken();
                console.log('üîë CSRF Token found:', !!csrfToken);
                
                // Build the URL - using absolute path to avoid issues
                const addToCartUrl = `/en/orders/cart/add/${productId}/`;
                console.log('üåê URL:', addToCartUrl);
                
                // Make AJAX request
                const response = await fetch(addToCartUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                console.log('üì® Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Response data:', data);
                
                if (data.success) {
                    // Show success state
                    this.innerHTML = '<i class="fas fa-check me-1"></i>{% trans "Added!" %}';
                    this.classList.remove('btn-warning', 'btn-loading');
                    this.classList.add('btn-success');
                    
                    // Update cart count
                    await updateCartCount();
                    
                    // Show success message
                    showToast(data.message || '{% trans "Sponsored product added to cart successfully!" %}', 'success');
                    
                } else {
                    // Show error state
                    this.innerHTML = '<i class="fas fa-times me-1"></i>{% trans "Failed" %}';
                    this.classList.remove('btn-warning', 'btn-loading');
                    this.classList.add('btn-danger');
                    
                    // Show error message
                    showToast(data.message || '{% trans "Failed to add sponsored product to cart" %}', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding to cart:', error);
                this.innerHTML = '<i class="fas fa-times me-1"></i>{% trans "Error" %}';
                this.classList.remove('btn-warning', 'btn-loading');
                this.classList.add('btn-danger');
                
                showToast('{% trans "Network error. Please check your connection and try again." %}', 'error');
            } finally {
                // Reset button after 2 seconds
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                    this.className = originalClass;
                }, 2000);
            }
        });
    });

    // Wishlist functionality
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.dataset.productId;
            const icon = this.querySelector('i');
            
            {% if not user.is_authenticated %}
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
            return;
            {% endif %}
            
            if (icon.classList.contains('far')) {
                icon.classList.replace('far', 'fas');
                icon.style.color = '#dc3545';
                showToast('{% trans "Added to wishlist!" %}', 'success');
            } else {
                icon.classList.replace('fas', 'far');
                icon.style.color = '';
                showToast('{% trans "Removed from wishlist" %}', 'info');
            }
        });
    });

    // Share functionality
    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productUrl = this.dataset.productUrl;
            const fullUrl = window.location.origin + productUrl;
            
            if (navigator.share) {
                navigator.share({
                    title: '{% trans "Sponsored Product on SokoLetu" %}',
                    text: '{% trans "Check out this sponsored product!" %}',
                    url: fullUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(fullUrl).then(() => {
                    showToast('{% trans "Sponsored product link copied to clipboard!" %}', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('{% trans "Failed to copy link" %}', 'error');
                });
            }
        });
    });

    // Update cart count function
    async function updateCartCount() {
        try {
            console.log('üîÑ Updating cart count...');
            const response = await fetch('{% url "orders:get_cart_count" %}', {
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch cart count');
            }
            
            const data = await response.json();
            console.log('üì¶ Cart count data:', data);
            
            const cartBadges = document.querySelectorAll('.cart-badge, .cart-badge-sidebar, .cart-badge-dropdown');
            console.log(`üéØ Updating ${cartBadges.length} cart badges`);
            
            cartBadges.forEach(badge => {
                const oldCount = parseInt(badge.textContent) || 0;
                const newCount = data.count || 0;
                
                console.log(`üîÑ Badge update: ${oldCount} -> ${newCount}`);
                
                badge.textContent = newCount;
                badge.classList.add('updated');
                setTimeout(() => badge.classList.remove('updated'), 600);
            });
            
        } catch (error) {
            console.error('‚ùå Error updating cart count:', error);
        }
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.custom-toast').forEach(toast => {
            toast.remove();
        });
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 100px; right: 20px; z-index: 1060; min-width: 300px;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : 
                  type === 'error' ? '<i class="fas fa-exclamation-triangle me-2"></i>' : 
                  type === 'warning' ? '<i class="fas fa-exclamation-circle me-2"></i>' :
                  '<i class="fas fa-info-circle me-2"></i>'}
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }

    // Initialize cart count on page load
    updateCartCount();
});
</script>
{% endblock %}